---
title: "plasma storage project - data analysis"
author: "Savannah Weaver"
date: "2023"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r setup, include = TRUE}
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("rmdformats")) install.packages("rmdformats")
library("rmdformats") # clean html R markdown format
if (!require("emmeans")) install.packages("emmeans")
library("emmeans") # marginal means
```



# Background and Goals

We will take our cleaned-up df from the wrangling Rmd, and make some figures and run some statistics to determine whether storage temperature and time affect the plasma osmolality of blood plasma samples. 





# Load Data

```{r}
dat <- read_rds("./data/osml_means_clean.RDS") %>% 
  mutate(Temp_Time = as.factor(paste(Temperature, Days, sep = " - ")))
```


Subset to only be push cap, because the screw cap storage was not great. :(

```{r}
dat_push <- dat %>% 
  dplyr::filter(tube == "push")

summary(dat_push)
```









# Statistics


## Marginal Means

Get the average osmolality for each time point/ temperature, and the pairwise statistical differences. 

check the lm assumptions of the 



### lm

Use this lm to determine whether the effects of temperature, time, or their interaction are statistically significant.

```{r}
lm_interaction <- lm(data = dat_push, osmolality_mmol_kg_mean ~ Temperature*Days)

# is the interaction helpful?
lm_single <- lm(data = dat_push, osmolality_mmol_kg_mean ~ Temperature + Days)

# compare
anova(lm_interaction, lm_single)
anova(lm_interaction)
anova(lm_single)
```

The temperature that plasma is stored at and the number of days it is stored *does* affect osmolality values, but the interaction is not significant.



### data wrangling

```{r}
remove <- dat_push %>% 
  dplyr::filter(Days != "0")
to_fix <- dat_push %>% 
  dplyr::filter(Days == "0")
fridge <- to_fix %>% 
  mutate(Temperature = "Refridgerator")
freezer <- to_fix %>% 
  mutate(Temperature = "Freezer")
together <- remove %>% 
  rbind(fridge) %>% 
  rbind(freezer)
```




### lm

Now, run a different lm version, with temperature and days as a single variable, to make the pairwise comparison easier. **I could not figure out how to run this otherwise**

```{r}
lm_arranged <- lm(data = together, osmolality_mmol_kg_mean ~ Temperature*Days)
```




### emmeans

Now, get the marginal means and pairwise differences between each sample group:

```{r}
emmeans <- data.frame(emmeans(lm_arranged, pairwise ~ Temperature | Days)$emmean) 

temp_diffs <- data.frame(emmeans(lm_arranged, pairwise ~ Temperature | Days)$contrasts)
temp_diffs

time_diffs <- data.frame(emmeans(lm_arranged, pairwise ~ Days | Temperature)$contrasts) %>% 
  dplyr::filter(substr(contrast, 1, 1) == "0")
time_diffs
```


SE **does** typically vary... interesting...


prep emmeans results for plotting...

```{r}
to_label <- emmeans %>% 
  dplyr::filter(Days == "0") %>% 
  # pick one to keep, they are the same
  dplyr::filter(Temperature == "Refridgerator") %>% 
  mutate(Temperature = "None")

all_good <- emmeans %>% 
  dplyr::filter(Days != "0") %>% 
  rbind(to_label)
```



## Variation Among Samples of the Same Group

Quantify the difference in spread for samples of the same "treatment" group.

```{r}

```




## Change

**I actually think this will be redundant :(**
What was the change for each time point/ temperature, and was it statistically different from zero?

Can I put t-test results into the same df as the change values I calculate?!






# Figure


## Pretty Stuff

```{r}
theme_set(theme_classic() +
            theme(text = element_text(color = "black", 
                                               family = "sans", 
                                               size = 12),
                           axis.text = element_text(color = "black", 
                                                    family = "sans", 
                                                    size = 8),
                           legend.text = element_text(color = "black", 
                                                      family = "sans", 
                                                      size = 8),
                           legend.text.align = 0,
                           legend.position = "bottom"
                           ))
```



## Means 


```{r}
ggplot() +
  geom_jitter(data = dat_push,
             aes(x = Days,
                 y = osmolality_mmol_kg_mean,
                 color = Temperature,
                 shape = Temperature),
             position = position_jitterdodge(jitter.height = 0, 
                                             jitter.width = 0.7,
                                             dodge.width = 0.8),
             alpha = 0.5,
             size = 2) +
  geom_point(data = all_good,
             aes(x = Days,
                 y = emmean,
                 shape = Temperature,
                 color = Temperature,
                 ),
             position = position_dodge(width = 0.8),
             alpha = 1,
             size = 3) +
  geom_errorbar(data = all_good,
                aes(x = Days,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL,
                 color = Temperature),
             position = position_dodge(width = 0.8),
                width = .2) +
  #annotate(geom = "text", x = 2, y = 19, label = "A", size = 3) +
  scale_color_manual(name = NULL, values = c("green", "blue", "gray")) +
  scale_shape_manual(name = NULL, values = c(15, 16, 17)) +
  scale_y_continuous(limits = c(310, 360), 
                     name = bquote('Osmolality (mmol '*kg^-1*')')) -> osml_values_plot
osml_values_plot
```


^ I should put none first in the legend

## Export

```{r}
ggsave(filename = "storage_effects.pdf",
       plot = osml_values_plot,
       path = "./results",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 160, height = 100
       )
```





## Change 















